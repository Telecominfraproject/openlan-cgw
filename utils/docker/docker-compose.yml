version: '3.9'

services:
  broker:
    image: docker.io/bitnami/kafka:latest
    ports:
      - "9092:9092"
      - "9094:9094"
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://127.0.0.1:9092,EXTERNAL://kafka_b:9094
      - KAFKA_BROKER_ID=1
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@127.0.0.1:9093
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - BITNAMI_DEBUG=yes
      - KAFKA_CFG_NUM_PARTITIONS=2
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
      

  postgresql:
    image: "postgres:latest"
    ports:
      - "5432:5432"
    user: postgres
    command: >
      bash -c "
        chown 999:999 /var/lib/postgresql/certs/server.key &&
        chmod 600 /var/lib/postgresql/certs/server.key &&
        postgres -c max_connections=400 -c shared_buffers=20MB -c ssl=on -c ssl_cert_file=/var/lib/postgresql/certs/server.crt -c ssl_key_file=/var/lib/postgresql/certs/server.key
      "
    env_file:
      - postgresql.env
    restart: always
    volumes:
      - ./postgresql/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
      - ./certs/:/var/lib/postgresql/certs/

  redis:
    image: 'bitnami/redis:latest'
    ports:
      - "6379:6379"
    volumes:
      - ./certs:/usr/local/etc/certs
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
      - REDIS_PORT_NUMBER=0
      - REDIS_TLS_ENABLED=yes
      - REDIS_TLS_PORT_NUMBER=6379
      - REDIS_TLS_CERT_FILE=/usr/local/etc/certs/server.crt
      - REDIS_TLS_KEY_FILE=/usr/local/etc/certs/server_redis.key
      - REDIS_TLS_CA_DIR=/usr/local/etc/certs
      - REDIS_TLS_AUTH_CLIENTS=no
